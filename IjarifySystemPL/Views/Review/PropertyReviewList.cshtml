@using IjarifySystemBLL.ViewModels.ReviewsViewModels
@model IEnumerable<ReviewItemViewModel>

<div class="reviews-section card border-0 shadow-sm p-4" style="border-radius: 20px;">
    <h4 class="mb-4 fw-bold text-dark">
        <i class="bi bi-chat-left-text-fill me-2 text-primary"></i>
        Comments (@Model.Count())
    </h4>

    <div class="reviews-list">
        @if (Model != null && Model.Any())
        {
            @foreach (var review in Model)
            {
                <div class="d-flex mb-4 review-item" id="review-@review.ReviewId">
                    <img src="/assets/img/real-estate/agent-1.webp" class="rounded-circle me-3 mt-1"
                         style="width: 45px; height: 45px; object-fit: cover; border: 2px solid #eee;">

                    <div class="flex-grow-1 p-3 bg-light position-relative" style="border-radius: 18px;">

                        @if (review.IsOwner)
                        {
                            <div class="position-absolute top-0 end-0 mt-2 me-2">
                                <div class="dropdown">
                                    <button class="btn btn-link text-muted p-0 shadow-none" data-bs-toggle="dropdown">
                                        <i class="bi bi-three-dots fs-5"></i>
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 animated fadeIn">
                                        <li>
                                            <button class="dropdown-item py-2" onclick="openEditModal(@review.ReviewId, '@review.Comment', @review.Rating)">
                                                <i class="bi bi-pencil me-2 text-primary"></i> Edit
                                            </button>
                                        </li>
                                        <li>
                                            <form asp-controller="Review" asp-action="Delete" method="post" onsubmit="return confirm('Are you sure you want to delete this comment?')">
                                                <input type="hidden" name="id" value="@review.ReviewId" />
                                                <input type="hidden" name="propertyId" value="@review.PropertyId" />
                                                <button type="submit" class="dropdown-item py-2 text-danger">
                                                    <i class="bi bi-trash me-2"></i> Delete
                                                </button>
                                            </form>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        }

                        <h6 class="fw-bold mb-0 text-dark">@review.UserName</h6>

                        <div class="text-warning mb-1" style="font-size: 0.75rem;">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi bi-star-fill @(i > review.Rating ? "text-secondary opacity-25" : "")"></i>
                            }
                            <small class="text-muted ms-1" style="font-size: 0.7rem;">@review.CreatedAt.ToString("MMM dd, yyyy")</small>
                        </div>

                        <p class="mb-0 text-secondary" style="font-size: 0.95rem; line-height: 1.5;">@review.Comment</p>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="text-center py-4 text-muted">
                <i class="bi bi-chat-dots fs-1 d-block mb-2 opacity-50"></i>
                No reviews yet. Be the first to share your experience!
            </div>
        }
    </div>

    <div class="d-flex mt-4 pt-4 border-top">
        <img src="/assets/img/real-estate/agent-1.webp" class="rounded-circle me-3" style="width: 40px; height: 40px; object-fit: cover;">
        <div class="flex-grow-1">
            <form asp-controller="Review" asp-action="Create" method="post" class="bg-light p-3 rounded-4 shadow-sm border">
                
                <input type="hidden" name="PropertyId" value="@(Model.FirstOrDefault()?.PropertyId ?? Convert.ToInt32(ViewContext.RouteData.Values["id"]))" />

                <div class="d-flex align-items-center mb-2">
                    <span class="small fw-bold text-muted me-2">Rating:</span>
                    <select name="Rating" class="form-select form-select-sm border-0 fw-bold text-warning" style="width: auto; cursor: pointer;">
                        <option value="5">⭐⭐⭐⭐⭐ (5)</option>
                        <option value="4">⭐⭐⭐⭐ (4)</option>
                        <option value="3">⭐⭐⭐ (3)</option>
                        <option value="2">⭐⭐ (2)</option>
                        <option value="1">⭐ (1)</option>
                    </select>
                </div>

                <div class="input-group">
                    <textarea name="Comment" class="form-control border-0 bg-transparent shadow-none"
                              placeholder="Write a comment..." rows="2" style="resize: none;"></textarea>
                    <button type="submit" class="btn btn-primary d-flex align-items-center px-4 rounded-3 ms-2">
                        Post <i class="bi bi-send ms-2"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="editReviewModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold">Edit Review</h5>
                <button type="button" class="btn-close shadow-none" data-bs-dismiss="modal"></button>
            </div>
            <form asp-controller="Review" asp-action="Edit" method="post">
                <div class="modal-body">
                    <input type="hidden" id="editReviewId" name="ReviewId" />
                    <input type="hidden" id="editPropertyId" name="PropertyId" value="@(Model.FirstOrDefault()?.PropertyId ?? Convert.ToInt32(ViewContext.RouteData.Values["id"]))" />

                    <div class="mb-3">
                        <label class="form-label small fw-bold">Your Rating</label>
                        <select class="form-select border-0 bg-light rounded-3" name="Rating" id="editRating">
                            <option value="5">5 Stars</option>
                            <option value="4">4 Stars</option>
                            <option value="3">3 Stars</option>
                            <option value="2">2 Stars</option>
                            <option value="1">1 Star</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">Your Comment</label>
                        <textarea class="form-control border-0 bg-light rounded-3" name="Comment" id="editComment" rows="4" style="resize: none;"></textarea>
                    </div>
                </div>
                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-light rounded-3 px-4" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success rounded-3 px-4">Update Review</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function openEditModal(id, comment, rating) {
        document.getElementById('editReviewId').value = id;
        document.getElementById('editComment').value = comment;
        document.getElementById('editRating').value = rating;
        var myModal = new bootstrap.Modal(document.getElementById('editReviewModal'));
        myModal.show();
    }
</script>