@model IjarifySystemBLL.ViewModels.FavouriteViewModels.UserFavouritesViewModel
@{
    ViewData["Title"] = "My Favourites";
}

<main class="main">

    <!-- Page Title -->
    <div class="page-title">
        <div class="heading">
            <div class="container">
                <div class="row d-flex justify-content-center text-center">
                    <div class="col-lg-8">
                        <h1 class="heading-title">My Favourites</h1>
                        <p class="mb-0">
                            Your saved properties are here. Browse through your favorite listings
                            and find your dream property. You can remove properties from your
                            favorites at any time.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        <nav class="breadcrumbs">
            <div class="container">
                <ol>
                    <li><a asp-controller="Home" asp-action="Index">Home</a></li>
                    <li class="current">My Favourites</li>
                </ol>
            </div>
        </nav>
    </div>
    <!-- End Page Title -->
    <!-- Favourites Section -->
    <section id="favourites" class="properties section">

        <div class="container" data-aos="fade-up" data-aos-delay="100">

            <div class="row">

                <div class="col-lg-12">

                    @if (Model.Favourites != null && Model.Favourites.Any())
                    {
                        <div class="properties-header mb-4">
                            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                                <div>
                                    <h5 class="mb-0">You have @Model.TotalCount saved properties</h5>
                                </div>
                                <div class="view-toggle d-flex gap-2">
                                    <button class="btn btn-outline-secondary btn-sm view-btn active" data-view="grid">
                                        <i class="bi bi-grid-3x3-gap"></i> Grid
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm view-btn" data-view="list">
                                        <i class="bi bi-list"></i> List
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Grid View -->
                        <div class="properties-grid view-grid active" data-aos="fade-up" data-aos-delay="200">
                            <div class="row g-4">

                                @foreach (var property in Model.Favourites)
                                {
                                    <div class="col-lg-4 col-md-6" data-favourite-id="@property.FavouriteId">
                                        <div class="property-card">
                                            <div class="property-image">
                                                @if (!string.IsNullOrEmpty(property.ImageUrl))
                                                {
                                                    <img src="@property.ImageUrl" alt="@property.PropertyTitle" class="img-fluid">
                                                }
                                                else
                                                {
                                                    <img src="~/assets/img/real-estate/property-placeholder.jpg" alt="@property.PropertyTitle" class="img-fluid">
                                                }
                                                <div class="property-badges">
                                                    <span class="badge for-sale">@property.ListingType</span>
                                                </div>
                                                <div class="property-overlay">
                                                    <button class="favorite-btn active" onclick="removeFavourite(@property.PropertyId, @property.FavouriteId)">
                                                        <i class="bi bi-heart-fill text-danger"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="property-content">
                                                <div class="property-price">$@property.Price.ToString("N0")</div>
                                                <h4 class="property-title">@property.PropertyTitle</h4>
                                                <p class="property-location">
                                                    <i class="bi bi-geo-alt"></i> @property.City, @property.Region
                                                </p>
                                                <div class="property-features">
                                                    <span><i class="bi bi-house"></i> @property.BedRooms Bed</span>
                                                    <span><i class="bi bi-water"></i> @property.BathRooms Bath</span>
                                                    <span><i class="bi bi-arrows-angle-expand"></i> @property.Area.ToString("N0") sqft</span>
                                                </div>
                                                <div class="property-meta mt-3 mb-3">
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar-check"></i> Added on @property.CreatedAt.ToString("MMM dd, yyyy")
                                                    </small>
                                                </div>
                                                <a href="@Url.Action("Details", "Property", new { id = property.PropertyId })" class="btn btn-teal w-100 rounded-pill">
                                                    <i class="bi bi-search"></i> View Details
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                }

                            </div>
                        </div>

                        <!-- List View -->
                        <div class="properties-list view-list" data-aos="fade-up" data-aos-delay="200">

                            @foreach (var property in Model.Favourites)
                            {
                                <div class="property-list-item" data-favourite-id="@property.FavouriteId">
                                    <div class="row align-items-center">
                                        <div class="col-lg-4">
                                            <div class="property-image">
                                                @if (!string.IsNullOrEmpty(property.ImageUrl))
                                                {
                                                    <img src="@property.ImageUrl" alt="@property.PropertyTitle" class="img-fluid">
                                                }
                                                else
                                                {
                                                    <img src="~/assets/img/real-estate/property-placeholder.jpg" alt="@property.PropertyTitle" class="img-fluid">
                                                }
                                                <div class="property-badges">
                                                    <span class="badge for-sale">@property.ListingType</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-lg-8">
                                            <div class="property-content">
                                                <div class="d-flex justify-content-between align-items-start mb-2">
                                                    <div>
                                                        <h4 class="property-title mb-1">@property.PropertyTitle</h4>
                                                        <p class="property-location mb-2">
                                                            <i class="bi bi-geo-alt"></i> @property.City, @property.Region, @property.Street
                                                        </p>
                                                    </div>
                                                    <div class="property-price">$@property.Price.ToString("N0")</div>
                                                </div>
                                                <div class="property-features mb-3">
                                                    <span><i class="bi bi-house"></i> @property.BedRooms Bed</span>
                                                    <span><i class="bi bi-water"></i> @property.BathRooms Bath</span>
                                                    <span><i class="bi bi-arrows-angle-expand"></i> @property.Area.ToString("N0") sqft</span>
                                                </div>
                                                <p class="text-muted mb-3">
                                                    @if (property.PropertyDescription.Length > 150)
                                                    {
                                                        @property.PropertyDescription.Substring(0, 150)
                                            
                                                        <text>...</text>
                                                    }
                                                    else
                                                    {
                                                        @property.PropertyDescription
                                                    }
                                                </p>
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">
                                                        <i class="bi bi-calendar-check"></i> Added @property.CreatedAt.ToString("MMM dd, yyyy")
                                                    </small>
                                                <div class="property-actions">
                                                        <button class="btn btn-danger btn-sm" onclick="removeFavourite(@property.PropertyId, @property.FavouriteId)">
                                                            <i class="bi bi-heart-fill"></i> Remove
                                                        </button>
                                                        <a href="@Url.Action("Details", "Property", new { id = property.PropertyId })" class="btn btn-teal btn-sm rounded-pill">
                                                            <i class="bi bi-search"></i> View Details
                                                        </a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }

                        </div>
                    }
                    else
                    {
                        <!-- Empty State -->
                        <div class="row">
                            <div class="col-12">
                                <div class="text-center py-5" data-aos="fade-up">
                                    <div class="mb-4">
                                        <i class="bi bi-heart" style="font-size: 5rem; color: #ccc;"></i>
                                    </div>
                                    <h3 class="mb-3">No Favourites Yet!</h3>
                                    <p class="text-muted mb-4">
                                        Start exploring properties and save your favorites by clicking the heart icon.
                                    </p>
                                                <a href="@Url.Action("Index", "Property")" class="btn btn-teal rounded-pill">
                                                    <i class="bi bi-search"></i> Browse Properties
                                                </a>
                                </div>
                            </div>
                        </div>
                    }

                </div>

            </div>

        </div>

    </section><!-- /Favourites Section -->

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-0 shadow">
                <div class="modal-header border-0 pb-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center px-4 pb-4">
                    <div class="mb-4">
                        <div class="rounded-circle bg-danger bg-opacity-10 d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <i class="bi bi-trash text-danger" style="font-size: 2.5rem;"></i>
                        </div>
                    </div>
                    <h4 class="mb-3">Remove from Favourites?</h4>
                    <p class="text-muted mb-0">Are you sure you want to remove this property from your favourites?</p>
                </div>
                <div class="modal-footer border-0 justify-content-center gap-2 pt-0 pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg me-1"></i> Cancel
                    </button>
                    <button type="button" class="btn btn-danger px-4" id="confirmDeleteBtn">
                        <i class="bi bi-trash me-1"></i> Remove
                    </button>
                </div>
            </div>
        </div>
    </div>
</main>

@section Scripts {
    <script>
        // Toggle between Grid and List view
        $(document).ready(function () {
            $('.view-btn').click(function () {
                var view = $(this).data('view');

                $('.view-btn').removeClass('active');
                $(this).addClass('active');

                if (view === 'grid') {
                    $('.properties-grid').addClass('active').show();
                    $('.properties-list').removeClass('active').hide();
                } else {
                    $('.properties-list').addClass('active').show();
                    $('.properties-grid').removeClass('active').hide();
                }
            });
        });

        // Remove favourite variables
        var deletePropertyId = null;
        var deleteFavouriteId = null;

        // Remove favourite function
        function removeFavourite(propertyId, favouriteId) {
            deletePropertyId = propertyId;
            deleteFavouriteId = favouriteId;
            var deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            deleteModal.show();
        }

        // Handle confirm delete button click
        document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
            if (deletePropertyId === null) return;
            
            var modal = bootstrap.Modal.getInstance(document.getElementById('deleteModal'));

            $.ajax({
                url: '@Url.Action("Remove", "Favourite")',
                type: 'POST',
                data: {
                    propertyId: deletePropertyId
                },
                success: function (response) {
                    modal.hide();

                    if (response.success) {
                        // Remove the card with animation
                        $('[data-favourite-id="' + deleteFavouriteId + '"]').fadeOut(400, function () {
                            $(this).remove();

                            // Check if no more favourites
                            if ($('.property-card').length === 0 && $('.property-list-item').length === 0) {
                                location.reload();
                            } else {
                                // Update count
                                var currentCount = parseInt($('.properties-header h5').text().match(/\d+/)[0]);
                                var newCount = currentCount - 1;
                                $('.properties-header h5').text('You have ' + newCount + ' saved properties');
                            }
                        });

                        // Show success message
                        showNotification('Removed from favourites successfully!', 'success');
                    } else {
                        showNotification('Failed to remove favourite. Please try again.', 'error');
                    }
                    
                    deletePropertyId = null;
                    deleteFavouriteId = null;
                },
                error: function () {
                    modal.hide();
                    showNotification('An error occurred. Please try again.', 'error');
                    deletePropertyId = null;
                    deleteFavouriteId = null;
                }
            });
        });

        // Simple notification function
        function showNotification(message, type) {
            var alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
            var notification = $('<div class="alert ' + alertClass + ' alert-dismissible fade show position-fixed" style="top: 20px; right: 20px; z-index: 9999;" role="alert">' +
                message +
                '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                '</div>');

            $('body').append(notification);

            setTimeout(function () {
                notification.alert('close');
            }, 3000);
        }
    </script>
}
